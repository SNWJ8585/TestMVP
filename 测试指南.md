# Museum-Flow-AI 测试指南

## 快速开始测试

### 第一步：安装依赖

在项目根目录打开终端，运行：

```bash
pip install -r requirements.txt
```

如果遇到网络问题，可以使用国内镜像：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 第二步：准备测试视频

1. 确保项目目录下有视频文件（例如 `sample.mp4`）
2. 如果没有，可以使用摄像头录制一小段视频，或下载测试视频

### 第三步：定义 ROI 区域（首次使用必须）

**方式 1：通过命令行工具（推荐）**

```bash
python test_roi.py
```

然后输入视频路径（例如：`sample.mp4`），按回车后会弹出 OpenCV 窗口：
- 鼠标左键拖拽绘制矩形区域
- 可以画多个区域
- 按 `S` 键保存并退出
- 按 `ESC` 或 `Q` 取消

**方式 2：通过 Streamlit 界面**

启动 Streamlit 后，在侧边栏点击"🎯 定义/编辑观测区域 (ROI)"

### 第四步：启动 Streamlit 界面

```bash
streamlit run app.py
```

浏览器会自动打开 `http://localhost:8501`

### 第五步：开始检测

1. **选择模式**：
   - **展示模式**：查看数据看板、异常报警、热力图
   - **调试模式**：可以实时调整参数（置信度、DBSCAN 参数等）

2. **配置参数**（调试模式）：
   - YOLO 置信度：0.25（默认）
   - DBSCAN 邻域半径：50.0（默认）
   - DBSCAN 最小人数：3（默认）
   - 最小停留时间：0.0 秒（默认）

3. **启动检测**：
   - 在侧边栏点击"▶️ 启动检测"
   - 左侧会显示实时视频流（带检测框、ROI、朝向箭头）
   - 右侧显示实时数据面板

### 第六步：查看日志输出

**自动导出**：
- 点击"⏹️ 停止检测"后，系统会自动在 `logs/` 目录生成日志文件
- 文件名格式：`session_YYYYMMDD_HHMMSS.json` 和 `session_YYYYMMDD_HHMMSS.csv`

**手动导出**：
- 在右侧面板的"📥 数据导出"区域
- 点击"📊 导出当前检测报告"按钮
- 可以下载 JSON 和 CSV 文件

### 第七步：查看日志文件

1. **查看 logs/ 目录**：
   ```bash
   dir logs
   # 或
   ls logs
   ```

2. **打开 CSV 文件**：
   - 用 Excel 或 WPS 打开 `session_*.csv`
   - 查看所有检测记录的详细信息

3. **查看 JSON 文件**：
   - 用文本编辑器或 JSON 查看器打开 `session_*.json`
   - 查看完整的结构化数据

## 测试检查清单

- [ ] 依赖安装成功
- [ ] 视频文件存在
- [ ] ROI 区域定义成功（config.json 有数据）
- [ ] Streamlit 界面正常打开
- [ ] 检测启动成功，能看到视频流
- [ ] 能看到检测框、ROI 框、朝向箭头
- [ ] 右侧数据面板显示人数和区域信息
- [ ] 停止检测后，logs/ 目录生成了日志文件
- [ ] CSV 文件可以用 Excel 正常打开
- [ ] JSON 文件格式正确

## 常见问题排查

### 问题 1：找不到视频文件

**错误信息**：`无法打开视频: sample.mp4`

**解决方法**：
- 检查视频路径是否正确
- 使用绝对路径，例如：`E:\Desktop\School Project\美术馆人流导览（新苗小挑）\TestMVP\sample.mp4`
- 或确保视频文件在项目根目录下

### 问题 2：YOLO 模型下载失败

**错误信息**：模型下载相关错误

**解决方法**：
- 确保网络连接正常
- 或手动下载 `yolov8n.pt` 放到项目根目录
- 下载地址：https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt

### 问题 3：没有检测到人

**可能原因**：
- 视频中没有人物
- YOLO 置信度设置过高
- 视频质量太低

**解决方法**：
- 在调试模式下，降低 YOLO 置信度（例如 0.1）
- 使用包含人物的测试视频

### 问题 4：日志文件没有生成

**可能原因**：
- 检测时间太短，没有数据
- 权限问题，无法写入 logs/ 目录

**解决方法**：
- 确保检测运行了至少几秒钟
- 检查 logs/ 目录是否存在且有写入权限
- 查看终端是否有错误信息

### 问题 5：Streamlit 界面卡顿

**解决方法**：
- 降低视频分辨率
- 减少检测区域数量
- 关闭其他占用资源的程序

## 测试数据示例

成功检测后，你应该能看到：

1. **实时视频流**：
   - 绿色矩形框（ROI 区域）
   - 红色圆点（人员中心）
   - 红色箭头（朝向）
   - 黄色圆圈（DBSCAN 聚类）
   - 黄色文字（人员 ID）

2. **数据面板**：
   - 当前馆内总人数
   - 各区域人数和平均停留时间
   - 异常报警信息

3. **日志文件**：
   - JSON：包含所有检测记录的完整数据
   - CSV：表格格式，便于分析

## 下一步

测试成功后，你可以：
- 调整参数优化检测效果
- 分析日志数据
- 查看历史趋势图和热力图
- 使用历史回放功能
