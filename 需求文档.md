1. 目录结构与模块定位Plaintext/museum_tool
├── app.py              # Streamlit 界面入口（包含调试页与展示页）
├── processor.py        # 引擎：核心算法、多线程视频流处理、公式计算
├── config_manager.py   # ROI 画框工具（生成/读取 config.json）
├── database.py         # 存储明细与聚合数据
├── components/         # 存放 UI 自定义组件
└── assets/             # 存放精美 CSS 或图标
2. 新增核心功能需求A. 视频回溯与时间段选择 (Time-segment Analysis)功能描述：在交互界面增加时间轴选择器。实现逻辑：通过 cv2.VideoCapture.set(cv2.CAP_PROP_POS_FRAMES, frame_id) 实现视频快速跳转。数据库增加 timestamp 字段。当用户选择特定时间段（如“昨日 14:00-15:00”）时，系统从数据库调取历史坐标进行离线回放渲染或热力图生成。B. 调试界面 (Debug Interface - 后台模式)根据图中提供的可调试变量，建立实时反馈机制：展品配置：实时加载并显示 area 坐标。停留时长阈值 ($T_{min}$)：设置滑块（如 0-300秒）。只有 $\Delta T_{dwell} \ge T_{min}$ 的点才在输出端标记为“有效观看”。DBSCAN 密度控制：邻域半径 ($\epsilon$)：控制聚类松散度。最小人数 ($MinPts$)：定义达到多少人才触发“群体拥挤”报警。C. 交互与输出界面 (Dashboard - 展示模式)输出数据看板 (Output Data)：实时区域状态：列表显示每个 area 的当前人数、平均停留时间。异常点报警：实时滚动显示“停留超时”或“高密度聚集”的具体点位坐标 $(x, y)$ 及所在区域。美化方案：使用 streamlit-echarts 绘制动态热力图和人流极坐标图。注入自定义 CSS，将界面改为深色博物馆艺术风格。3. 核心算法公式 (同步图中逻辑)朝向计算：$\theta = \operatorname{atan2}(y_t - y_{t-1}, x_t - x_{t-1}) \times \frac{180}{\pi}$停留时长：$\Delta T_{dwell}(ID_i) = t_{exit}(ID_i) - t_{entry}(ID_i)$聚类密度：基于 $dist(p,q) = \sqrt{(x_p-x_q)^2 + (y_p-y_q)^2}$ 判断邻域 $N_{\epsilon}(p)$，若点集数量 $\ge MinPts$，则标记为核心人群。4. 发送给 Cursor 的开发指令 (Prompts)第一步：基础框架与调试引擎“请帮我重构项目。首先编写 app.py，使用 st.sidebar 创建调试面板，包含以下参数：YOLO 置信度、DBSCAN 的 Eps 和 MinPts、以及 $T_{min}$ (最小停留时间)。主界面要求能通过 st.file_uploader 上传视频，并提供一个 st.slider 进度条，允许我选择视频的不同时间段进行跳跃检测。”第二步：数据输出与持久化“请在 database.py 中建立 SQLite 逻辑，记录每帧的 ID、坐标、所属 Area 和朝向。在 UI 的右侧，参考图片要求，创建一个‘输出数据’面板：实时显示每个区域对应的 ID 列表。当检测到停留时间 > $T_{min}$ 或人群密度 > $MinPts$ 时，在列表下方记录该点的 $(x, y)$ 坐标和时间戳。”第三步：UI 美化与热力图“现在优化交互界面。请使用 streamlit-echarts 或 plotly 在视频下方增加一个实时更新的热力图。热力图的数据应来自过去 5 分钟的坐标累计。界面风格请调整为深色科技感，符合美术馆数据大屏的调性。”5. 完整运行流程图操作指南：调试：先在调试界面拖动 Eps 和 MinPts，观察视频画面中聚类圆圈的覆盖情况，直到它能准确圈出人群。设置：调整 $T_{min}$。如果画面中有路过的行人，通过提高 $T_{min}$ 过滤掉他们，只保留真正驻足观看的观众数据。分析：在展示界面点击“历史记录”，选择视频前 10 分钟或后 10 分钟，对比不同时间段的客流密度变化。